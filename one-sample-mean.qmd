---
title: "One-sample mean"
page-layout: custom
format: 
  live-html:
    include-in-header: 
      - text: |
          <style>
          #quarto-content {
            padding: 1em 1.5em;
          }
          </style>
engine: knitr
---

{{< include ./_extensions/r-wasm/live/_knitr.qmd >}}

```{webr}
#| edit: false
#| output: false

library(infer)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggdist)
library(forcats)
library(htmltools)
library(gt)
library(parameters)

options(webr.fig.height = 4)
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 14))

# From MoMAColors::moma.colors("OKeeffe")
clrs <- c("#f3d567", "#ee9b43", "#e74b47", "#b80422", "#172767", "#19798b")
```

::::::: {.grid}

::::: {.g-col-12 .g-col-md-4}

```{ojs}
//| echo: false

viewof sample_size = Inputs.range([30, 2000], {
  step: 10,
  value: 100,
  label: "Sample size:"
})

viewof comparison_value = Inputs.range([20, 80], {
  step: 1,
  value: 40,
  label: "Comparison value (μ₀):"
})

viewof effect_size = Inputs.range([-10, 10], {
  step: 1,
  value: 5,
  label: "Difference from μ₀:"
})
```

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - sample_size
#|   - comparison_value
#|   - effect_size
#| define:
#|   - data_ready

sample_data <- tibble(
  outcome = rnorm(sample_size, mean = comparison_value + effect_size, sd = 10)
)

data_ready <- TRUE

ggplot(sample_data, aes(x = outcome, y = 0)) +
  stat_histinterval(
    fill = clrs[5],
    slab_color = "white",
    slab_linewidth = 0.5,
    outline_bars = TRUE,
    breaks = breaks_fixed(width = 3)
  ) +
  geom_vline(
    xintercept = comparison_value,
    color = clrs[4], linewidth = 1.5, linetype = "dashed"
  ) +
  annotate(
    "label",
    x = comparison_value, y = 0.8,
    label = paste0("μ₀ = ", comparison_value),
    size = 12, size.unit = "pt",
    color = clrs[4], fontface = "bold"
  ) +
  labs(x = "Outcome", y = NULL) +
  scale_y_continuous(breaks = NULL)
```

:::::

::::: {.g-col-12 .g-col-md-8}

:::: {.panel-tabset}

## Step 1: Calculate δ

The sample statistic (δ) is the **difference between the sample mean and the comparison value** (μ₀).

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - data_ready
#| define:
#|   - step1_ready

obs_stat <- sample_data |>
  specify(response = outcome) |>
  calculate(stat = "mean")

sample_mean <- obs_stat$stat
delta <- sample_mean - comparison_value

summary_table <- t.test(sample_data$outcome, mu = comparison_value) |> 
  model_parameters(verbose = FALSE) |>
  mutate(label = "Sample mean") |> 
  as_tibble() |> 
  select(label, value = Mean, CI_low, CI_high) |> 
  add_row(label = "Comparison value (μ₀)", value = comparison_value) |> 
  add_row(label = "Difference (δ)", value = delta)

step1_ready <- TRUE

tags$p(
  "The sample mean is ",
  tags$strong(round(sample_mean, 2)),
  " and the comparison value is ",
  tags$strong(comparison_value),
  ", so δ = ",
  tags$strong(round(delta, 2)),
  "."
)

summary_table |>
  gt() |>
  cols_label(
    label = "",
    value = "Value",
    CI_low = "95% CI"
  ) |>
  cols_hide(columns = c(CI_high)) |>
  cols_merge(
    columns = c(CI_low, CI_high),
    rows = 1,
    pattern = "[{1}, {2}]"
  ) |>
  fmt_number(columns = c(value, CI_low, CI_high), decimals = 2) |>
  sub_missing(missing_text = "") |>
  tab_style(
    style = cell_fill(color = clrs[5], alpha = 0.1),
    locations = cells_body(rows = label == "Sample mean")
  ) |>
  tab_style(
    style = cell_fill(color = clrs[2], alpha = 0.1),
    locations = cells_body(rows = label == "Comparison value (μ₀)")
  ) |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "white"),
      cell_fill(color = clrs[4])
    ),
    locations = cells_body(rows = label == "Difference (δ)")
  ) |> 
  opt_horizontal_padding(scale = 3)
```

## Step 2: Simulate null world

We create a null distribution by recentering and bootstrapping. We shift our data so its average equals the comparison value (μ₀), then resample from that shifted data (with replacement) hundreds of times. **This creates a world where the population mean is the comparison value.**

Think of this as being a world where the true mean is μ₀. Importantly, this *doesn't* mean that every bootstrapped sample mean will be *exactly* μ₀. There is variation in the data, and that variation is reflected in the null world. What it means is that in the null world, the sample mean is μ₀ ± some amount.

Here's what this null world looks like:

```{ojs}
//| echo: false
viewof n_reps = Inputs.range([100, 2000], {
  step: 100,
  value: 500,
  label: "Number of simulations:"
})
```

::: {style="width: 75%;"}

```{webr}
#| autorun: true
#| echo: false
#| out-width: 50%
#| input:
#|   - step1_ready
#|   - n_reps
#| define:
#|   - step2_ready

null_dist <- sample_data |>
  specify(response = outcome) |>
  hypothesize(null = "point", mu = comparison_value) |>
  generate(reps = n_reps, type = "bootstrap") |>
  calculate(stat = "mean")

step2_ready <- TRUE

null_dist |>
  visualize() +
  labs(
    title = "Simulated null world",
    x = "Bootstrapped mean",
    y = "Count"
  )
```

:::

## Step 3: Put δ in the null world

Next we put our observed sample mean inside that null world and see how comfortably it fits there.

Is it surprising to see the red line in this null world? Is the line way out to one of the sides, or is it near the middle with the rest of the null world?

::: {style="width: 75%;"}

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - step2_ready

null_dist |>
  visualize() +
  geom_vline(xintercept = obs_stat$stat, color = "red2", linewidth = 2) +
  geom_label(
    data = obs_stat,
    aes(
      x = stat, y = I(0.5),
      label = paste0("x̄ =\n", round(stat, 2))
    ),
    size = 14,
    size.unit = "pt",
    lineheight = 1
  ) +
  labs(
    title = "Simulated null world with observed mean in it",
    x = "Sample mean",
    y = "Count"
  )
```

:::

## Step 4: p-value

We can actually quantify the probability of seeing that red line in a null world. This is a **p-value**—the probability of seeing a sample mean at least that far from μ₀ in a world where the true mean is μ₀.

::: {style="width: 75%;"}

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - step2_ready
#| define:
#|   - step4_ready

p_value <- null_dist |>
  get_p_value(obs_stat = obs_stat, direction = "two-sided") |>
  suppressWarnings()

if (p_value$p_value == 0) {
  p_value_clean <- "< 0.001"
  p_percent <- "< 0.1%"
} else {
  p_value_clean <- round(p_value$p_value, 3)
  p_percent <- paste0(round(p_value$p_value * 100, 1), "%")
}

null_with_p <- null_dist |>
  visualize() +
  shade_p_value(obs_stat = obs_stat, direction = "two-sided") +
  geom_label(
    data = obs_stat,
    aes(
      x = stat, y = I(0.5),
      label = paste0("x̄ =\n", round(stat, 2))
    ),
    size = 14,
    size.unit = "pt",
    lineheight = 1
  ) +
  geom_label(
    data = obs_stat,
    aes(x = stat, y = I(0.25)),
    label = paste0("p =\n", p_value_clean),
    size = 14,
    size.unit = "pt",
    lineheight = 1
  ) +
  labs(
    title = "Simulated null world with observed mean in it",
    x = "Sample mean",
    y = "Count"
  )
null_with_p

step4_ready <- TRUE

tags$div(
  tags$p("The p-value is ", tags$strong(p_value_clean)),
  tags$p(
    "This means that in a world where the true mean is ",
    tags$strong(comparison_value),
    ", there is a ",
    tags$strong(p_percent),
    " chance of seeing a sample mean at least as far as ",
    tags$strong(round(obs_stat$stat, 2)),
    " from μ₀"
  )
)
```

:::

## Step 5: Decision

Finally, we have to decide if the p-value meets an evidentiary standard or threshold that would provide us with enough evidence that we *aren't* in the null world (or, in more statsy terms, enough evidence to reject the null hypothesis).

There are lots of possible thresholds. By convention, most people use a threshold (often shortened to α) of 0.05, or 5%. But that's not required! You could have a lower standard with an α of 0.1 (10%), or a higher standard with an α of 0.01 (1%).

```{ojs}
//| echo: false
viewof alpha = Inputs.select([0.10, 0.05, 0.01], {
  label: "Significance threshold (α):",
  value: 0.05
})
```

:::: {.grid}

::: {.g-col-12 .g-col-md-6}

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - step4_ready
#|   - alpha

if (p_value$p_value < alpha) {
  tags$div(
    class = "alert alert-success",
    role = "alert",
    tags$h5(class = "alert-heading", "Statistically significant"),
    tags$p(
      "The p-value is ",
      tags$strong(p_value_clean),
      "and our threshold for α is ",
      tags$strong(alpha)
    ),
    tags$p(
      "In a world where the true mean is ",
      tags$strong(comparison_value),
      ", the probability of seeing a sample mean at least as far as ",
      tags$strong(round(obs_stat$stat, 2)),
      " from μ₀ is ",
      tags$strong(p_percent)
    ),
    tags$p(
      "Since ",
      p_value_clean,
      " is less than ",
      alpha,
      ", we have enough evidence to say that the difference is ",
      tags$strong("statistically significant.")
    )
  )
} else {
  tags$div(
    class = "alert alert-warning",
    role = "alert",
    tags$h5(class = "alert-heading", "Not statistically significant"),
    tags$p(
      "The p-value is ",
      tags$strong(p_value_clean),
      "and our threshold for α is ",
      tags$strong(alpha)
    ),
    tags$p(
      "In a world where the true mean is ",
      tags$strong(comparison_value),
      ", the probability of seeing a sample mean at least as far as ",
      tags$strong(round(obs_stat$stat, 2)),
      " from μ₀ is ",
      tags$strong(p_percent)
    ),
    tags$p(
      "Since ",
      p_value_clean,
      " is greater than ",
      alpha,
      ", we don't have enough evidence to say that the mean differs from μ₀. The difference is thus ",
      tags$strong("not statistically significant.")
    ),
    tags$hr(),
    tags$p(
      style = "font-size: 0.9em;",
      "This does ",
      tags$strong("not"),
      " mean that the true mean equals μ₀! We just don't have enough evidence to judge if it differs."
    )
  )
}
```

:::

::: {.g-col-12 .g-col-md-6}

```{webr}
#| autorun: true
#| echo: false
#| input:
#|   - step4_ready

null_with_p
```

:::

::::

{{< include _evidentiary-standards.qmd >}}

::::

:::::

:::::::
