---
title: "Regular p-values"
toc: true
toc-depth: 2
code-fold: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 6 * 0.618, 
  fig.align = "center", 
  out.width = "100%"
)

# Make the display() function create {tinytable} tables
options(easystats_display_format = "tt", width = 300)
```

So far all the examples on this site calculated p-values through simulation---shuffling and resampling to build null worlds. 

**In real life, you won't actually do this!**

Regular statistical tests like R's `t.test()`, `prop.test()`, and `lm()` skip the simulation and instead use known theoretical distributions (like the *t*, *F*, and $\chi^2$ distributions) to approximate null worlds and calculate p-values. This theoretical, mathematical p-value is what you see in regular statistical output.

Even though they're not based on simulations, **the intuition is the same**: a p-value is still the probability of seeing a $\delta$ at least that large in a world where there is no difference.

```{r}
#| warning: false
#| message: false

library(tidyverse)
library(scales)
library(ggdist)
library(ggbeeswarm)
library(parameters)
library(tinytable)

penguins <- penguins |> drop_na(sex)

theme_set(theme_minimal(base_size = 14))

# From MoMAColors::moma.colors("OKeeffe")
clrs <- c(
  "#f3d567",
  "#ee9b43",
  "#e74b47",
  "#b80422",
  "#172767",
  "#19798b"
)
```

## Difference in means

This is the same thing the [difference in means](diff-in-means.qmd) example calculates through simulation---just computed with a formula instead.

Here's the average body mass across species:

```{r}
#| echo: false

avg_weight <- penguins |>
  group_by(species) |>
  summarize(avg_weight = mean(body_mass))
```

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
avg_weight |> 
  tt()
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
ggplot(penguins, aes(x = species, y = body_mass, color = species)) +
  geom_beeswarm(side = -1, size = 1, cex = 1.5) +
  stat_pointinterval(.width = 0.95, position = position_nudge(x = 0.2)) +
  scale_y_continuous(labels = label_number(scale_cut = cut_si("g"))) +
  scale_color_manual(values = c(clrs[2], clrs[4], clrs[5]), guide = "none") +
  labs(x = "Species", y = "Body mass")
```

:::

::::

We can ask a couple questions here about the differences in means.

#### Is there a difference in body mass between Chinstrap and Gentoo penguins?

We're looking at the difference between these two values:

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
avg_weight |> 
  tt() |> 
  style_tt(i = 2:3, background = clrs[1])
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
avg_weight |> 
  mutate(highlight = species %in% c("Chinstrap", "Gentoo")) |> 
  ggplot(aes(x = species, y = avg_weight, fill = species)) +
  geom_col(aes(color = highlight), linewidth = 2) +
  scale_y_continuous(labels = label_number(scale_cut = cut_si("g"))) +
  scale_color_manual(values = c(NA, clrs[1]), guide = "none") +
  scale_fill_manual(values = c(clrs[2], clrs[4], clrs[5]), guide = "none") +
  labs(x = "Species", y = "Average weight")
```

:::

::::

```{r}
#| code-fold: show

t.test(
  body_mass ~ species,
  data = filter(penguins, species %in% c("Chinstrap", "Gentoo"))
)
```

```{r}
#| echo: false

t.test(
  body_mass ~ species,
  data = filter(penguins, species %in% c("Chinstrap", "Gentoo"))
) |>
  model_parameters() |>
  display(caption = "", select = "short")
```

The p-value here is essentially zero (p < 2.2 × 10^−16^). In a world where Chinstrap and Gentoo penguins had the same average body mass, it would be virtually impossible to see a difference this large.

#### Is there a difference in body mass between Adelie and Chinstrap penguins?

We're looking at the difference between these two values:

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
avg_weight |> 
  tt() |> 
  style_tt(i = 1:2, background = clrs[1])
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
avg_weight |> 
  mutate(highlight = species %in% c("Chinstrap", "Adelie")) |> 
  ggplot(aes(x = species, y = avg_weight, fill = species)) +
  geom_col(aes(color = highlight), linewidth = 2) +
  scale_y_continuous(labels = label_number(scale_cut = cut_si("g"))) +
  scale_color_manual(values = c(NA, clrs[1]), guide = "none") +
  scale_fill_manual(values = c(clrs[2], clrs[4], clrs[5]), guide = "none") +
  labs(x = "Species", y = "Average weight")
```

:::

::::

```{r}
#| code-fold: show

t.test(
  body_mass ~ species,
  data = filter(penguins, species %in% c("Adelie", "Chinstrap"))
)
```

```{r}
#| echo: false

t.test(
  body_mass ~ species,
  data = filter(penguins, species %in% c("Adelie", "Chinstrap"))
) |>
  model_parameters() |>
  display(caption = "", select = "short")
```

## One-sample mean

This is the theoretical version of the [one-sample mean](one-sample-mean.qmd) simulation, where we bootstrap a null world centered at a hypothesized value.

#### Is the average body mass of all penguins in the dataset different from 4000 g?

```{r}
#| echo: false

mass_summary <- tibble(
  n = nrow(penguins),
  `Sample mean` = mean(penguins$body_mass),
  `μ₀` = 4000
)
```

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
mass_summary |> tt()
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
ggplot(penguins, aes(x = body_mass)) +
  geom_histogram(
    binwidth = 200,
    fill = clrs[5], color = "white"
  ) +
  geom_vline(
    xintercept = 4000,
    color = clrs[3], linewidth = 1.5
  ) +
  annotate(
    "label",
    x = 4000, y = Inf, vjust = 1.5,
    label = "μ₀ = 4000 g", size = 4
  ) +
  labs(x = "Body mass (g)", y = "Count")
```

:::

::::

```{r}
#| code-fold: show

t.test(penguins$body_mass, mu = 4000)
```

```{r}
#| echo: false

t.test(penguins$body_mass, mu = 4000) |>
  model_parameters() |>
  display(caption = "", select = "short")
```

The p-value tells us the probability of seeing a sample mean this far from 4000 g in a world where the true average really is 4000 g. The small p-value gives us evidence that the true mean is not 4000 g.

## Difference in proportions

This is the theoretical version of the [difference in proportions](diff-in-props.qmd) simulation.

Is the proportion of female penguins the same in Adelie and Gentoo species?

```{r}
#| echo: false

penguins_prop <- penguins |>
  filter(species %in% c("Adelie", "Gentoo")) |>
  group_by(species) |>
  summarize(
    n_female = sum(sex == "female"),
    n = n(),
    prop_female = n_female / n
  )
```

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
penguins_prop |> tt()
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
ggplot(
  penguins_prop,
  aes(x = species, y = prop_female, fill = species)
) +
  geom_col() +
  scale_y_continuous(labels = label_percent()) +
  scale_fill_manual(
    values = c(clrs[2], clrs[5]),
    guide = "none"
  ) +
  labs(x = "Species", y = "Proportion female")
```

:::

::::

```{r}
#| code-fold: show

prop.test(
  x = penguins_prop$n_female,
  n = penguins_prop$n
)
```

```{r}
#| echo: false

prop.test(
  x = penguins_prop$n_female,
  n = penguins_prop$n
) |>
  model_parameters() |>
  display(caption = "", select = "short")
```

This time the p-value is large---both species have roughly the same proportion of females. In a world where the two species truly had the same proportion of females, it would be completely unsurprising to see a difference this small. There is not enough evidence to say the proportions are different; the result is not statistically significant.

Not every test produces a tiny p-value! A large p-value doesn't mean there's *no* difference---just that the data don't provide enough evidence to distinguish a real difference from random variation.

## Regression

This is the theoretical version of the [regression slope](regression.qmd) simulation, where we shuffle the outcome to build a null world where the slope is zero.

Does flipper length predict body mass?

```{r}
#| echo: false

reg_summary <- penguins |>
  summarize(
    n = n(),
    `Cor(x, y)` = cor(flipper_len, body_mass)
  )
```

:::: {.grid}

::: {.g-col-12 .g-col-md-4}

```{r}
reg_summary |> tt()
```

:::

::: {.g-col-12 .g-col-md-8}

```{r}
ggplot(
  penguins,
  aes(x = flipper_len, y = body_mass)
) +
  geom_point(color = clrs[5], alpha = 0.5) +
  geom_smooth(
    method = "lm",
    color = clrs[3], se = FALSE
  ) +
  labs(
    x = "Flipper length (mm)",
    y = "Body mass (g)"
  )
```

:::

::::

```{r}
#| code-fold: show

penguin_model <- lm(
  body_mass ~ flipper_len,
  data = penguins
)

summary(penguin_model)
```

```{r}
#| echo: false

penguin_model |>
  model_parameters() |>
  display(caption = "", select = "short")
```

In regression output, each coefficient has its own p-value. The p-value for `flipper_len` tests whether the slope is different from zero---in a world where flipper length had no relationship with body mass (a slope of zero), it would be essentially impossible to see a slope this steep (p < 2.2 × 10^−16^).
